<!DOCTYPE html><html lang="en"><head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<meta name="description" content="iCn3D Structure Viewer">
<meta name="ncbi_db" content="structure">
<meta name="keywords" content="NCBI, Structure, JavaScript, iCn3D, 3D, Viewer, WebGL, three.js, sequence, chemical">
<meta name="robots" content="index,follow,noarchive">
<title>iCn3D: Web-based 3D Structure Viewer</title>
</head>
<body>

  <div id="div0"></div>
  <div style="clear: both"></div>
  <div id="seq0" class="icn3d-box" style="overflow:auto;">
		<div id="giseq" class="scale"></div>
		<div id="snp" class="scale"></div>
		<div id="interaction" class="scale"></div>
		<div id="cddsite" class="scale"></div>
		<div id="domain" class="scale"></div>
  </div>
  <br/><br/>

  <!--link rel="stylesheet" href="lib/jquery-ui.min.css"-->
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

  <link rel="stylesheet" href="icn3d_full_ui.css">
  <style>
  .icn3d-seqTitle, .icn3d-seqTitle2, .icn3d-annoTitle {display:inline-block; font-size:11px; font-weight:bold; width:120px!important;}
  #seq0 {max-height:150px;}
  .link {color: #0000FF; cursor: pointer;}
  .left {text-align:left!important;}
  .right {text-align:right!important;}
  .icn3d-clinvar {color:green; font-size:12px; font-weight:bold;}
  .icn3d-clinvar-path {color:purple; font-size:12px; font-weight:bold;}

//  .scale {-ms-transform:scaleX(1); -webkit-transform:scaleX(1); transform:scaleX(1); -ms-transform-origin-x: 0; -webkit-transform-origin-x: 0;  transform-origin-x: 0; }

  // for jquery tooltip
  label {
      display: inline-block;
      width: 200px; // 5em;
  }
	.ui-widget {
		font-family: Arial,Helvetica,sans-serif;
		font-size: 0.9em!important;
	}
  </style>
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

  <!--script src="lib/jquery.min.js"></script>
  <script src="lib/jquery-ui.min.js"></script-->
  <script src="lib/three.min.js"></script>










  <script src="full_ui_all.js"></script>

  <script type="text/javascript">

    // separating the GET parameters from the current URL
    var bNopara = false;
    var ampPos = document.URL.indexOf("?");
    if(ampPos === -1) {
    //  alert("Please include '?queries=[nucleotide id]&targets=[gi or accession]' in your url");
    	bNopara = true;
    }

    var getParams = document.URL.split("?");
    // transforming the GET parameters into a dictionnary
    var search = getParams[getParams.length - 1];
    var params = {};
    var inpara = "";

    if(!bNopara) {
    	params = JSON.parse('{"' + decodeURI(search).replace(/"/g, '\\"').replace(/&/g, '","').replace(/=/g,'":"') + '"}');

    	// for mmdb structures, pass the parameters after the first "&" sign
      	inpara = "&" + document.URL.substr(ampPos + 1);
    }

    //var nid = params.queries;

    var gi = params.id; // gi or accession such as 4B3O_A. Accession is preferred
    var pdbid, CHAIN, bInputPdb = false;
    if(isNaN(gi)) {
      pdbid = gi.substr(0, 4);
      CHAIN = gi.substr(5);
      bInputPdb = true;
    }

    var command = params.command; // ";" separated commands

    // add label for selections
    var SELECT = params.select;

    var LABEL = params.label;

    var SIZE = params.size;
    if(SIZE === undefined) SIZE = 30;

    var COLOR = params.color;
    if(COLOR === undefined) COLOR = 'FFFF00';

    var BACKGROUND = params.background;
    if(BACKGROUND === undefined) BACKGROUND = 0;

	// jquery tooltip
	//https://stackoverflow.com/questions/18231315/jquery-ui-tooltip-html-with-links
	$(function () {
		$(document).tooltip({
			content: function () {
				return $(this).prop('title');
			},
			show: null,
			close: function (event, ui) {
				ui.tooltip.hover(

				function () {
					$(this).stop(true).fadeTo(400, 1);
				},

				function () {
					$(this).fadeOut("400", function () {
						$(this).remove();
					})
				});
			}
		});
	});

    $( document ).ready(function() {
          //======== section 1: set iCn3D
/*
		iCn3DUI.prototype.hideMenu = function(width, height) { var me = this;
		  if($("#" + me.pre + "menulist")[0] !== undefined) $("#" + me.pre + "menulist")[0].style.display = "none";
		  if($("#" + me.pre + "menuLogSection")[0] !== undefined) $("#" + me.pre + "menuLogSection")[0].style.display = "none";
		  if($("#" + me.pre + "commandlog")[0] !== undefined) $("#" + me.pre + "commandlog")[0].style.display = "none";
		  if($("#" + me.pre + "selection")[0] !== undefined) $("#" + me.pre + "selection")[0].style.display = "none";

		  //if($("#" + me.pre + "title")[0] !== undefined) $("#" + me.pre + "title")[0].style.display = "none";
		  $("#" + me.pre + "title")[0].style.margin = "10px 0 0 10px";

		  $("#" + me.pre + "viewer").width(width).height(height);
		  $("#" + me.pre + "canvas").width(width).height(height);
		};
*/

/*
		// show interactions in download2Ddiagram
		iCn3DUI.prototype.download2Ddiagram = function(mmdbid, structureIndex) {var me = this;
		  me.deferred3 = $.Deferred(function() {
			var url="https://www.ncbi.nlm.nih.gov/Structure/mmdb/mmdb_strview.cgi?uid="+mmdbid+"&format=json&intrac=3";
			$.ajax({
				url: url,
				dataType: 'jsonp',
				success: function( data ) {
					me.draw2Ddiagram(data, mmdbid, structureIndex);

					//start to show interactions-------------
					//        var residueArray = me.chainids2resids[chainid1][chainid2];
					var chainname2residues = {};

					var chainArray = Object.keys(me.icn3d.chains);
					var dnaArray = [];
					for(var i = 0, il = chainArray.length; i < il; ++i) {
						var atom = me.icn3d.getFirstAtomObj(me.icn3d.chains[chainArray[i]]);
						if(me.icn3d.ligands.hasOwnProperty(atom.serial)) { // 1. ligand interact with proteins
							var chain2Array = Object.keys(me.chainids2resids[chainArray[i]]);
							for(var j = 0, jl = chain2Array.length; j < jl; ++j) {
								var name = 'Ligand: Chain ' + chain2Array[j].substr(chain2Array[j].indexOf('_') + 1);
								chainname2residues[name] = me.chainids2resids[chainArray[i]][chain2Array[j]];
							}
						}
						else if(me.icn3d.nucleotides.hasOwnProperty(atom.serial)) { // 1. DNA interact with proteins
							dnaArray.push(chainArray[i]);
						}
					}

					// show DNA interaction only if a few DNAs are available
					if(dnaArray.length <= 2)
						for(var i = 0, il = dnaArray.length; i < il; ++i) {
							var chain2Array = Object.keys(me.chainids2resids[chainArray[i]]);
							for(var j = 0, jl = chain2Array.length; j < jl; ++j) {
								var name = 'Nucleotide: Chain ' + chain2Array[j].substr(chain2Array[j].indexOf('_') + 1);
								chainname2residues[name] = me.chainids2resids[chainArray[i]][chain2Array[j]];
							}
						}
					}

console.log("chainname2residues: " + JSON.stringify(chainname2residues));
			    var html = '<div id="interseq_sequence" class="icn3d-dl_sequence">';

			    var siteArray = data.data[0].sites;

			    for(var chainname in chainname2residues) {
					var residueArray = chainname2residues[chainname];
					var resCnt = residueArray.length;

					var title = chainname;
					if(title.length > 20) title = title.substr(0, 20) + '...';

					var fulltitle = title;

					var resPosArray = [];
					for(var i = 0, il = residueArray.length; i < il; ++i) {
						resPosArray.push( residueArray[i].substr(residueArray[i].lastIndexOf('_') + 1) );
					}

					html += '<div class="icn3d-seqTitle link" interaction="interaction" posarray="' + resPosArray.toString() + '" shorttitle="' + title + '" anno="sequence" title="' + fulltitle + '">' + title + ' </div>';
					html += '<span class="icn3d-seqLine">';
					html += '<span class="icn3d-residueNum" title="residue count in the site">' + resCnt.toString() + ' Residues</span>';

					var pre = 'inter';
					for(var i = 0, il = icn3dui.giSeq.length; i < il; ++i) {
					  if(resPosArray.indexOf(i) != -1) {
					    var c = icn3dui.giSeq.charAt(i);
					    var pos = (i+1).toString();

					  	html += '<span id="' + pre + '_' + chainname + '" title="' + c + pos + '" class="icn3d-residue">' + c + '</span>';
					  }
					  else {
					  	html += '<span></span>'; //'<span>-</span>';
					  }
					}
					html += '<span class="icn3d-residueNum" title="residue count in the site">' + resCnt.toString() + ' Residues</span>';
					html += '</span>';
					html += '<br>';
				}

				html += '</div>';

				$("#" + interactiondivid).html(html);

				// add here after the ajax call
				//selectSequenceNonMobile();

					//end -------------

					if(me.cfg.show2d !== undefined && me.cfg.show2d) me.openDialog(me.pre + 'dl_2ddiagram', 'Interactions');
					if(me.deferred3 !== undefined) me.deferred3.resolve();
				}
			});
		  });

		  return me.deferred3;
		};
*/

		iCn3DUI.prototype.setTools = function() { var me = this;
			// start of original code ==============
        var html = "";

        html += "  <div id='" + me.pre + "selection' style='position:absolute; z-index:555; float:left; display:table-row; margin: 32px 0px 0px 3px;'>";
        html += "    <table style='margin-top: 3px; width:100px;'><tr valign='center'>";

        html += "        <td valign='top'><div class='icn3d-commandTitle' style='min-width:40px; margin-top: 24px; white-space: nowrap;'><span id='" + me.pre + "modeall' title='Style, color, and surface menu options will be applied to all atoms in the structure'>All atoms</span><span id='" + me.pre + "modeselection' class='icn3d-modeselection' style='display:none;' title='Style, color, and surface menu options will be applied only to selected atoms'>Selection</span></div>";
        html += "        <label class='icn3d-switch'><input id='" + me.pre + "modeswitch' type='checkbox'><div class='icn3d-slider icn3d-round' style='width:34px; height:18px; margin: 12px 0px 0px 3px;' title='Left (\"All atoms\"): Style, color, and surface menu options will be applied to all atoms in the structure&#13;Right (\"Selection\"): Style, color, and surface menu options will be applied only to selected atoms'></div></label></td>";

        if(me.cfg.cid === undefined) {
            html += "        <td valign='top'><span class='icn3d-commandTitle'>Structure:</span><br/>";
            html += "        <div style='margin-top:-3px;'><select id='" + me.pre + "structureid' multiple size='1' style='min-width:50px;'>";
            html += "        </select></div></td>";

            if(me.cfg.align !== undefined) {
                html += "        <td valign='top'><span class='icn3d-commandTitle'>Aligned:</span><br/>";
                html += "        <div style='margin-top:-3px;'><select id='" + me.pre + "alignChainid' multiple size='1' style='min-width:50px;'>";
                html += "        </select></div></td>";
            }
            else {
                html += "        <td valign='top'><span class='icn3d-commandTitle'>Chain:</span><br/>";
                html += "        <div style='margin-top:-3px;'><select id='" + me.pre + "chainid' multiple size='1' style='min-width:50px;'>";
                html += "        </select></div></td>";
            }
        }

        html += "        <td valign='top'><span class='icn3d-commandTitle'>Custom:</span><br/>";
        html += "        <div style='margin-top:-3px;'><select id='" + me.pre + "customResidues' multiple size='1' style='min-width:50px;'>";
        html += "        </select></div></td>";

        var buttonStyle = me.isMobile() ? 'none' : 'button';

        if(me.cfg.cid === undefined) {
            html += "      <td valign='top'><div style='margin:3px 0px 0px 10px;'><button style='-webkit-appearance:" + buttonStyle + "; height:36px;' id='" + me.pre + "show_sequences'><span style='white-space:nowrap' class='icn3d-commandTitle' title='Show the sequences of the selected structure'>View<br/>Sequence</span></button></div></td>";

            if(me.cfg.align !== undefined) {
                html += "      <td valign='top'><div style='margin:3px 0px 0px 10px;'><button style='-webkit-appearance:" + buttonStyle + "; height:36px;' id='" + me.pre + "show_alignsequences'><span style='white-space:nowrap' class='icn3d-commandTitle' title='Show the sequences of the aligned structures'>Aligned<br/>Sequence</span></button></div></td>";
            }

            if(me.cfg.mmdbid !== undefined || me.cfg.gi !== undefined || me.cfg.align !== undefined) {
                html += "      <td valign='top'><div style='margin:3px 0px 0px 10px;'><button style='-webkit-appearance:" + buttonStyle + "; height:36px;' id='" + me.pre + "show_2ddiagram'><span style='white-space:nowrap' class='icn3d-commandTitle' title='Show the interactions of the structure'>View<br/>Interactions</span></button></div></td>";
            }

            html += "      <td valign='top'><div id='" + me.pre + "alternateWrapper' style='margin:3px 0px 0px 10px;'><button style='-webkit-appearance:" + buttonStyle + "; height:36px;' id='" + me.pre + "alternate'><span style='white-space:nowrap' class='icn3d-commandTitle' title='Alternate the structures'>Alternate<br/>(Key \"a\")</span></button></div></td>";
        }

        html += "      <td valign='top'><div style='margin:3px 0px 0px 10px;'><button style='-webkit-appearance:" + buttonStyle + "; height:36px;' id='" + me.pre + "show_selected'><span style='white-space:nowrap' class='icn3d-commandTitle' title='Display ONLY the selected atoms'>Display Only<br/>Selection</span></button></div></td>";

        html += "      <td valign='top'><div style='margin:3px 0px 0px 10px;'><button style='-webkit-appearance:" + buttonStyle + "; height:36px;' id='" + me.pre + "toggleHighlight'><span style='white-space:nowrap' class='icn3d-commandTitle' title='Turn on and off the 3D highlight in the viewer'>Toggle<br/>Highlight</span></button></div></td>";

        //html += "      <td valign='top'><div style='margin:3px 0px 0px 10px;'><button style='-webkit-appearance:" + buttonStyle + "; height:36px;' id='" + me.pre + "clearall'><span style='white-space:nowrap' class='icn3d-commandTitle' title='Clear all selections'>Clear<br/>All</span></button></div></td>";

        html += "      <td valign='top'><div style='margin:3px 0px 0px 10px;'><button style='-webkit-appearance:" + buttonStyle + "; height:36px;' id='" + me.pre + "resetorientation'><span style='white-space:nowrap' class='icn3d-commandTitle' title='Reset Orientation'>Reset<br/>Orientation</span></button></div></td>";

			// only one button below was changed
			if(me.cfg.align === undefined) {
				html += "      <td valign='top'><div style='margin:3px 0px 0px 10px;'><button style='-webkit-appearance:" + buttonStyle + "; height:36px;' id='prevclin'><span style='white-space:nowrap' class='icn3d-commandTitle' title='Show the previous ClinVar on structure'>Previous<br>ClinVar</span></button></div></td>";
				html += "      <td valign='top'><div style='margin:3px 0px 0px 10px;'><button style='-webkit-appearance:" + buttonStyle + "; height:36px;' id='nextclin'><span style='white-space:nowrap' class='icn3d-commandTitle' title='Show the next ClinVar on structure'>Next<br>ClinVar</span></button></div></td>";
			}

        html += "    </tr></table>";
        html += "    </div>";

        return html;
        };

          var cfg = {
              divid: 'div0',
              width: '100%',
              height: '80%',
              resize: false,
              rotate: false,
              showmenu: true,
              showseq: false,
              command: command
          };

          if(pdbid === undefined) {
          	cfg['gi'] = gi;
          }
          else {
            cfg['mmdbid'] = pdbid;
          }

          var icn3dui = new iCn3DUI(cfg);
          icn3dui.options['background'] = 'black';

          //communicate with the 3D viewer with chained functions
          //$.when(icn3dui.show3DStructure()).then(function() {
          	//if(sel !== undefined && !isNaN(sel) ) icn3dui.loadScript("color grey; select :" + sel + "-" + sel + "; color red; select zone cutoff 5; color blue");
          //});

        //======== section 2: set sequence
        var gidivid = 'giseq';
        var cdddivid = 'cddsite';
        var domaindivid = 'domain';
        var snpdivid = 'snp';
        var interactiondivid = 'interaction';

        var bShowAllDna = false;
        var giChainid = '';

        function showSeq(data) {
          	var strArray = data.split('\n');
          	var title = strArray[0]; // remove the first line of title
          	var pos = title.indexOf('Chain'); // >pdb|1LPA|B Chain B, ...
          	if(pos > 0) giChainid = title.substr(5, 4) + '_' + title.substr(pos + 6, 1);

          	strArray.shift();

          	var giSeq = strArray.join('');
          	icn3dui.giSeq = giSeq;

          	var divLength = 10 * icn3dui.giSeq.length + 250;

          	$("#giseq").width(divLength);
          	$("#snp").width(divLength);
          	$("#cddsite").width(divLength);
          	$("#domain").width(divLength);

//console.log("seq: " + icn3dui.giSeq);

          	if(SELECT !== undefined && LABEL !== undefined) {
				var selectArray = SELECT.split(',');
				var residues = '';
				for(var i = 0, il = selectArray.length; i < il; ++i) {
				  var resiArray = selectArray[i].split('-');
				  if(resiArray.length == 1) {
					var pos = parseInt(resiArray[0]);
					if(pos !== undefined && pos-1 <= giSeq.length && pos-1 >= 1) {
					  residues += pos.toString() + ',';
					}
				  }
				  else if(resiArray.length == 2) {
					var pos1 = parseInt(resiArray[0]);
					var pos2 = parseInt(resiArray[1]);

					if(pos1 !== undefined && pos2 !== undefined) {
					  if(pos1 < 1) pos1 = 1;
					  if(pos2 > giSeq.length) pos2 = giSeq.length;

					  residues += pos1.toString() + '-' + pos2.toString() + ',';
					}
				  }
				}

				if(command === undefined) command = '';

				command += 'select .' + CHAIN + ':' + residues + '; add label ' + LABEL + ' | size ' + SIZE + ' | color ' + COLOR + ' | background ' + BACKGROUND + ' | type custom';

				icn3dui.cfg.command=command;
			}

			// gi html
			var html = '<div id="giseq_sequence" class="icn3d-dl_sequence">';

          	// html to display protein positions (10, 20, etc)
          	html += '<div class="icn3d-residueLine" style="white-space:nowrap;">';
			//html += '<div class="icn3d-annoTitle" gi="' + gi + '" anno="0">Protein Count</div>';
			html += '<div class="icn3d-annoTitle" gi="' + gi + '" anno="0"></div>';
			html += '<span class="icn3d-residueNum"></span>';

          	for(var i = 0, il = giSeq.length; i < il; ++i) {
          	  if( (i+1) % 10 === 0) {
          	  	html += '<span>' + (i+1).toString() + '</span>';
          	  }
          	  else {
          	  	html += '<span></span>'; //'<span>-</span>';
          	  }
          	}
			html += '<span class="icn3d-residueNum"></span>';
			html += '<br>';
			html += '</div>';

			// sequence
			if(pdbid === undefined) {
			  html += '<div class="icn3d-seqTitle" gi="' + gi + '" anno="sequence"><span style="white-space:nowrap; font-size:1.3em;">Protein gi ' + gi + '</span></div>';
			}
			else {
			  html += '<div class="icn3d-seqTitle" gi="' + gi + '" anno="sequence"><span style="white-space:nowrap; font-size:1.3em;">Protein ' + gi + '</span></div>';
			}

			html += '<span class="icn3d-seqLine">';
			html += '<span class="icn3d-residueNum" title="starting protein sequence number">1</span>';

          	for(var i = 0, il = giSeq.length; i < il; ++i) {
          	  var c = giSeq.charAt(i);
          	  var pos = (i+1).toString();
          	  html += '<span id="' + gidivid + '_' + gi + '_' + pos + '" title="' + c + pos + '" class="icn3d-residue">' + c + '</span>';
          	}
			html += '<span class="icn3d-residueNum" title="ending protein sequence number">' + i.toString() + '</span>';
			html += '</span>';
			html += '<br>';

			html += '</div>';

			$("#" + gidivid).html(html);

        } // function showSeq(data)

		function selectSequenceNonMobile() { var me = icn3dui;
		  $("#giseq_sequence").add("#cddseq_sequence").add("#domainseq_sequence").add("#snpseq_sequence").add("#interseq_sequence").selectable({
		  //$("#cddseq_sequence").add("#domainseq_sequence").selectable({
			  stop: function() {
				  $("#" + me.pre + "chainid").val("");
				  $("#" + me.pre + "structureid").val("");

				  $("#" + me.pre + "chainid2").val("");
				  $("#" + me.pre + "structureid2").val("");

				  me.removeSeqChainBkgd();
				  me.removeSeqResidueBkgd();

				  me.icn3d.highlightAtoms = {};
				  removeAllLabels();

				  // select residues
				  $(".ui-selected", this).each(function() {
					  var id = $(this).attr('id');
					  //if(id !== undefined && id !== '' && id !== 'snpseq' && id !== 'giseq' && id !== 'cddsite' && id !== 'domain') {
					  if(id !== undefined && id !== '') {

						$(this).toggleClass('icn3d-highlightSeq');

						//for(var chainid in me.icn3d.chains) {
						var chainid;
						if(bInputPdb) {
						  chainid = pdbid + '_' + CHAIN;
						}
						else {
						  chainid = giChainid; //Object.keys(me.icn3d.chains)[0];
						}

						  // protein chains
						  var atomIndex = Object.keys(me.icn3d.chains[chainid])[0];
						  if(!me.icn3d.ligands.hasOwnProperty( atomIndex ) && !me.icn3d.ions.hasOwnProperty( atomIndex ) && !me.icn3d.water.hasOwnProperty( atomIndex )) {
//console.log("chainid: " + chainid + " atomIndex: " + atomIndex);
							//var residueid = id.substr(id.indexOf('_') + 1);
							var residueid;
							residueid = chainid + "_" + id.substr(id.lastIndexOf('_') + 1);

							if(me.icn3d.residues.hasOwnProperty(residueid)) {
								if($(this).hasClass('icn3d-highlightSeq')) {
								  for(var j in me.icn3d.residues[residueid]) {
									me.icn3d.highlightAtoms[j] = 1;
								  }
								  me.selectedResidues[residueid] = 1;

								  //if($(this).attr('label') !== undefined) {
								  if($(this).attr('disease') !== undefined) {
									  var label = $(this).attr('disease');

									  var position = me.icn3d.centerAtoms(me.icn3d.hash2Atoms(me.icn3d.residues[residueid]));
									  //position.center.add(new THREE.Vector3(3.0, 3.0, 3.0)); // shift a little bit

									  var maxlen = 15;
									  if(label.length > maxlen) label = label.substr(0, maxlen) + '...';

									  addLabel(label, position);
								  }
								}
								else {
									for (var i in me.icn3d.residues[residueid]) {
									  me.icn3d.highlightAtoms[i] = undefined;
									}
									me.selectedResidues[residueid] = undefined;

									me.icn3d.removeHighlightObjects();
								}
							}
						  } // end of if
						//} // end of for
					  }
				  });

				  me.icn3d.addHighlightObjects();

/*
				  // get all chainid in the selected residues
				  var chainHash = {};
				  for(var residueid in me.selectedResidues) {
					  var pos = residueid.lastIndexOf('_');
					  var chainid = residueid.substr(0, pos);

					  chainHash[chainid] = 1;
				  }

				  // highlight the nodes
				  var chainArray2d = Object.keys(chainHash);
				  me.add2DHighlight(chainArray2d);
*/

				  me.icn3d.addResiudeLabels(me.icn3d.highlightAtoms);

				  me.icn3d.draw();

				  // update menu
				  $("#" + me.pre + "chainid").val("");
				  $("#" + me.pre + "structureid").val("");

				  $("#" + me.pre + "chainid2").val("");
				  $("#" + me.pre + "structureid2").val("");

				  // select annotation title
				  $(".ui-selected", this).each(function() {
					  //var currChain = $(this).attr('chain');
					  if($(this).hasClass('icn3d-seqTitle') && $(this).attr('nid') === undefined && $(this).attr('gi') === undefined) {
						me.removeSeqChainBkgd();
						me.removeSeqResidueBkgd();

						$(this).toggleClass('icn3d-highlightSeq');

						//var chainid = $(this).attr('chain');
						//var commandname = chainid;

						if($(this).hasClass('icn3d-highlightSeq')) {
							//me.selectAChain(chainid, commandname);
							//me.setLogCommand('select chain ' + chainid, true);
							var commandname = $(this).attr('shorttitle');
							var commanddescr = commandname;

							if($(this).attr('domain') !== undefined) {
								var from = parseInt($(this).attr('from'));
								var to = parseInt($(this).attr('to'));

								me.icn3d.highlightAtoms = {};

								removeAllLabels();

								//for(var chainid in me.icn3d.chains) {
								var chainid;
								if(bInputPdb) {
								  chainid = pdbid + '_' + CHAIN;
								}
								else {
								  chainid = giChainid; //Object.keys(me.icn3d.chains)[0];
								}

								  // protein chains
								  var atomIndex = Object.keys(me.icn3d.chains[chainid])[0];
								  if(!me.icn3d.ligands.hasOwnProperty( atomIndex ) && !me.icn3d.ions.hasOwnProperty( atomIndex ) && !me.icn3d.water.hasOwnProperty( atomIndex )) {
									var residueidHash = {};
									var residueid;
									for(var i = from; i < to; ++i) {
										residueid = chainid + '_' + (i+1).toString();
										residueidHash[residueid] = 1;
									}

									me.selectResidueList(residueidHash, commandname, commanddescr);

									residueid = chainid + '_' + parseInt((from + to)/2).toString();
									//residueid = chainid + '_' + from.toString();
									var position = me.icn3d.centerAtoms(me.icn3d.hash2Atoms(me.icn3d.residues[residueid]));

									addLabel(commandname, position);
								  } // end of if
								//} // end of for
							}
							else if($(this).attr('site') !== undefined || $(this).attr('clinvar') !== undefined) {
								var posArray = $(this).attr('posarray').split(',');

								me.icn3d.highlightAtoms = {};

								removeAllLabels();

								//for(var chainid in me.icn3d.chains) {
								var chainid;
								if(bInputPdb) {
								  chainid = pdbid + '_' + CHAIN;
								}
								else {
								  chainid = giChainid; //Object.keys(me.icn3d.chains)[0];
								}

								  // protein chains
								  var atomIndex = Object.keys(me.icn3d.chains[chainid])[0];
								  if(!me.icn3d.ligands.hasOwnProperty( atomIndex ) && !me.icn3d.ions.hasOwnProperty( atomIndex ) && !me.icn3d.water.hasOwnProperty( atomIndex )) {
									var residueidHash = {};
									var residueid;
									for(var i = 0, il = posArray.length; i < il; ++i) {
										residueid = chainid + '_' + (parseInt(posArray[i])+1).toString();
										residueidHash[residueid] = 1;
									}

									me.selectResidueList(residueidHash, commandname, commanddescr);

									residueid = chainid + '_' + posArray[parseInt((0 + posArray.length)/2)].toString();
									//residueid = chainid + '_' + posArray[0].toString();
									var position = me.icn3d.centerAtoms(me.icn3d.hash2Atoms(me.icn3d.residues[residueid]));

									addLabel(commandname, position);

									// do no tshow each rsidue
									//me.icn3d.addResiudeLabels(me.icn3d.highlightAtoms);

								  } // end of if
								//} // end of for
							}

							me.icn3d.addHighlightObjects();

							me.icn3d.draw();
						}
						else {
							me.icn3d.removeHighlightObjects();
							me.remove2DHighlight();

							me.icn3d.highlightAtoms = {};

						   $("#" + me.pre + "customResidues").val("");
						   $("#" + me.pre + "customResidues2").val("");
						   $("#" + me.pre + "customAtoms").val("");
						}
					  }
				  });
			  }
		  });
		}

		function addLabel(label, position) { var me = icn3dui;
			var x = position.center.x;
			var y = position.center.y;
			var z = position.center.z;

			//me.addLabel(text, x,y,z, size, color, background, type);
			var size = parseInt(me.icn3d.LABELSIZE * 10 / label.length);
			var color = me.icn3d.GREYD;
			me.addLabel(label, x,y,z, size, color, undefined, 'custom');

			//me.icn3d.draw();
		}

		function removeAllLabels() { var me = icn3dui;
           for(var name in me.icn3d.labels) {
               if(name === 'residue' || name === 'custom') {
                   me.icn3d.labels[name] = [];
               }
           }
		}

		function navClinVar() {
			icn3dui.currClin = - 1;

			$("#prevclin").on('click', function(e) {
			  e.preventDefault();

			  --icn3dui.currClin;
			  if(icn3dui.currClin < 0) icn3dui.currClin = 0;

			  showClinVarLabelOn3D();
			});

			$("#nextclin").on('click', function(e) {
			  e.preventDefault();

			  ++icn3dui.currClin;
			  if(icn3dui.currClin > icn3dui.resi2disease_nonempty.length - 1) icn3dui.currClin = icn3dui.resi2disease_nonempty.length - 1;

			  showClinVarLabelOn3D();
			});
		}

		function showClinVarLabelOn3D() {
			  var resiArray = Object.keys(icn3dui.resi2disease_nonempty);

				var chainid, residueid;

				if(bInputPdb) {
				  chainid = pdbid + '_' + CHAIN;
				}
				else {
				  chainid = giChainid; //Object.keys(me.icn3d.chains)[0];
				}

				residueid = chainid + '_' + resiArray[icn3dui.currClin];

				var label = '';

				var diseaseArray = icn3dui.resi2disease_nonempty[resiArray[icn3dui.currClin]];

				for(var k = 0, kl = diseaseArray.length; k < kl; ++k) {
					if(diseaseArray[k] != '' && diseaseArray[k] != 'not specified' && diseaseArray[k] != 'not provided') {
						label = diseaseArray[k];
						break;
					}
				}

			  var position = icn3dui.icn3d.centerAtoms(icn3dui.icn3d.hash2Atoms(icn3dui.icn3d.residues[residueid]));
			  //position.center.add(new THREE.Vector3(3.0, 3.0, 3.0)); // shift a little bit

			  var maxlen = 15;
			  if(label.length > maxlen) label = label.substr(0, maxlen) + '...';

				icn3dui.icn3d.labels = {};

			    addLabel(label, position);

console.log("residueid: " + residueid);

				icn3dui.icn3d.highlightAtoms = {};

				for(var j in icn3dui.icn3d.residues[residueid]) {
					icn3dui.icn3d.highlightAtoms[j] = 1;
				}

				icn3dui.icn3d.addHighlightObjects();

				icn3dui.icn3d.addResiudeLabels(icn3dui.icn3d.highlightAtoms);


			  icn3dui.icn3d.draw();
        }

		function getSnpLine(line, totalLineNum, resi2snp, resi2rsnum, resi2clinAllele, resi2index, resi2sig, posarray, posClinArray, bStartEndRes) {
			var html = '';

			if(bStartEndRes) {
				var title1 = 'ClinVar', title2 = 'SNP';

				html += '<div class="icn3d-seqTitle link icn3d-clinvar-path" clinvar="clinvar" posarray="' + posClinArray + '" shorttitle="' + title1 + '" anno="sequence" title="' + title1 + '" style="width:60px!important;">' + title1 + ', </div>';
				html += '<div class="icn3d-seqTitle link" clinvar="clinvar" posarray="' + posarray + '" shorttitle="' + title2 + '" anno="sequence" title="' + title2 + '" style="width:60px!important;">' + title2 + '</div>';
			}
			else {
				html += '<div class="icn3d-seqTitle"></div>';
			}

			var pre = 'snp';

			html += '<span class="icn3d-seqLine">';
			var start = bStartEndRes ? '1' : '';
			html += '<span class="icn3d-residueNum" title="starting protein sequence number">' + start + '</span>';
			var diseaseStr = '';
			for(var i = 1, il = icn3dui.giSeq.length; i <= il; ++i) {
			  //if(resi2snp[i] !== undefined) {
			  if(resi2index[i] !== undefined && resi2index[i] % totalLineNum == line ) {
				var c = icn3dui.giSeq.charAt(i-1);
				var pos = i.toString();

				var snpStr = c + '>', snpTitle = '';
				var snpType = '';

				for(var j = 0, jl = resi2snp[i].length; j < jl; ++j) {
					snpStr += resi2snp[i][j];
					snpTitle += pos + c + '>' + resi2snp[i][j];

					// disease and significace
					var diseaseArray = icn3dui.resi2disease[i][j].split('; ');
					var sigArray = resi2sig[i][j].split('; ');

					var diseaseTitle = '';
					var index = 0;
					for(var k = 0, kl = diseaseArray.length; k < kl; ++k) {
						if(diseaseArray[k] != '' && diseaseArray[k] != 'not specified' && diseaseArray[k] != 'not provided') {
							if(index > 0) {
								diseaseTitle += '; ';
							}
							else {
								if( j === 0) diseaseStr = 'disease="' + diseaseArray[k] + '"';
							}

							diseaseTitle += diseaseArray[k] + ' (' + sigArray[k] + ')';
							++index;
						}
					}

					//resi2rsnum, resi2clinAllele,

					if(diseaseTitle != '') {
						snpType = 'icn3d-clinvar';

						snpTitle += ': ' + diseaseTitle;
						snpTitle += "<br>Links: <a href='https://www.ncbi.nlm.nih.gov/clinvar/?term=" + resi2clinAllele[i][j] + "[AlleleID]' target='_blank'>ClinVar</a>, <a href='https://www.ncbi.nlm.nih.gov/snp/?term=" + resi2rsnum[i][j] + "' target='_blank'>dbSNP (rs" + resi2rsnum[i][j] + ")</a>";
					}
					else {
						snpTitle += "<br>Links: <a href='https://www.ncbi.nlm.nih.gov/snp/?term=" + resi2rsnum[i][j] + "' target='_blank'>dbSNP</a>"
					}

					if(j < jl - 1) {
						snpStr += ';';
						snpTitle += '<br><br>';
					}
				}

				if(snpTitle.indexOf('Pathogenic') != -1) {
					snpType = 'icn3d-clinvar-path';
				}

				html += '<span id="' + pre + '_' + gi + '_' + pos + '" label title="' + snpTitle + '" ' + diseaseStr + ' class="icn3d-residue ' + snpType + '">' + snpStr + '</span>';
			  }
			  else {
				html += '<span></span>'; //'<span>-</span>';
			  }
			}
			var end = bStartEndRes ? icn3dui.giSeq.length : '';
			html += '<span class="icn3d-residueNum" title="ending protein sequence number">' + end + '</span>';
			html += '</span>';
			html += '<br>';

			return html;
		}

		function showSnp() {
			// show conserved domains and binding sites
			//var url = "https://test.ncbi.nlm.nih.gov/projects/SNP/beVarSearch.cgi?appname=iCn3D&format=bed&report=pdb2bed&gi=" + gi;
			//var url = "https://test.ncbi.nlm.nih.gov/projects/SNP/beVarSearch_mt.cgi?appname=iCn3D&format=bed&report=pdb2bed&gi=" + gi;

			var url;
			if(bInputPdb) {
				url = "https://www.ncbi.nlm.nih.gov/projects/SNP/beVarSearch_mt.cgi?appname=iCn3D&format=bed&report=pdb2bed&acc=" + gi;
			}
			else {
				url = "https://www.ncbi.nlm.nih.gov/projects/SNP/beVarSearch_mt.cgi?appname=iCn3D&format=bed&report=pdb2bed&gi=" + gi;
			}

			$.ajax({
			  url: url,
			  dataType: 'text',
			  cache: true,
			  success: function(data) {
			    var html = '<div id="snpseq_sequence" class="icn3d-dl_sequence">';

				var lineArray = data.split('\n');

				var resi2snp = {};
				var resi2index = {};
				//var resi2disease = {};
				icn3dui.resi2disease = {};
				icn3dui.resi2disease_nonempty = {};
				var resi2sig = {};

				var resi2rsnum = {};
				var resi2clinAllele = {};

				var posHash = {}, posClinHash = {};
				for(var i = 0, il = lineArray.length; i < il; ++i) {
				 if(lineArray[i] != '') {
				  var fieldArray = lineArray[i].split('\t');

				  var snpStr = fieldArray[3];

				  var resiStr = snpStr.substr(0, snpStr.length - 3);

				  var resi = parseInt(resiStr);
				  var currRes = snpStr.substr(snpStr.length - 3, 1);
				  var snpRes = snpStr.substr(snpStr.length - 1, 1);

				  var rsnum = fieldArray[4];
				  var clinAllele = fieldArray[5];
				  var disease = fieldArray[6];  // When more than 2+ diseases, they are separated by "; "
				  								// Some are "not specified", "not provided"
				  var clinSig = fieldArray[7]; 	// Clinical significance, When more than 2+ diseases, they are separated by "; "

				  // "*" means terminating codon, "-" means deleted codon
				  //if(currRes !== '-' && currRes !== '*' && snpRes !== '-' && snpRes !== '*') {
					    posHash[resi] = 1;
					    if(disease != '') posClinHash[resi] = 1;
					    resi2index[resi] = i + 1;

						if(resi2snp[resi] === undefined) {
							resi2snp[resi] = [];
						}
						resi2snp[resi].push(snpRes);

						if(resi2rsnum[resi] === undefined) {
							resi2rsnum[resi] = [];
						}
						resi2rsnum[resi].push(rsnum);

						if(resi2clinAllele[resi] === undefined) {
							resi2clinAllele[resi] = [];
						}
						resi2clinAllele[resi].push(clinAllele);

						if(icn3dui.resi2disease[resi] === undefined) {
							icn3dui.resi2disease[resi] = [];
						}
						icn3dui.resi2disease[resi].push(disease);

						if(disease != '') {
							if(icn3dui.resi2disease_nonempty[resi] === undefined) {
								icn3dui.resi2disease_nonempty[resi] = [];
							}
							icn3dui.resi2disease_nonempty[resi].push(disease);
						}

						if(resi2sig[resi] === undefined) {
							resi2sig[resi] = [];
						}
						resi2sig[resi].push(clinSig);

				  //}
				 }
				}

				var posarray = Object.keys(posHash);
				var posClinArray = Object.keys(posClinHash);

//console.log("resi2snp: " + JSON.stringify(resi2snp));

				html += getSnpLine(1, 3, resi2snp, resi2rsnum, resi2clinAllele, resi2index, resi2sig, posarray, posClinArray, 1);
				html += getSnpLine(2, 3, resi2snp, resi2rsnum, resi2clinAllele, resi2index, resi2sig, posarray, posClinArray, 0);
				html += getSnpLine(0, 3, resi2snp, resi2rsnum, resi2clinAllele, resi2index, resi2sig, posarray, posClinArray, 0);

				html += '</div>';

				$("#" + snpdivid).html(html);

				// add here after the ajax call
				selectSequenceNonMobile();
			  }
			})
			.fail(function() {
				alert( "No SNP data were found for the gi " + gi + "..." );
			});
		}

		function showCddSite() {
			// show conserved domains and binding sites
			var url = "https://www.ncbi.nlm.nih.gov/Structure/cdannots/cdannots.fcgi?fmt&queries=" + gi;
			$.ajax({
			  url: url,
			  dataType: 'json',
			  cache: true,
			  success: function(data) {
			    var html = '<div id="cddseq_sequence" class="icn3d-dl_sequence">';

			    var domainArray = data.data[0].doms;

			    for(var index = 0, indexl = domainArray.length; index < indexl; ++index) {
					var acc = domainArray[index].acc;
					var type = domainArray[index].type;
					var title = type + ': ' + domainArray[index].title.split(':')[0];
					var fulltitle = type + ': ' + domainArray[index].title + ' (accession: ' + acc + ')';

					var domainFrom = parseInt(domainArray[index].locs[0].segs[0].from);
					var domainTo = parseInt(domainArray[index].locs[0].segs[0].to);
					var range = domainTo - domainFrom + 1;

					html += '<div class="icn3d-seqTitle link" domain="' + acc + '" from="' + domainFrom.toString() + '" to="' + domainTo.toString() + '" shorttitle="' + title + '" anno="sequence" title="' + fulltitle + '">' + title + ' </div>';
					html += '<span class="icn3d-seqLine">';
					html += '<span class="icn3d-residueNum" title="starting protein sequence number">' + (domainFrom+1).toString() + '</span>';

					var pre = type + index.toString();
					for(var i = 0, il = icn3dui.giSeq.length; i < il; ++i) {
					  if(i >= domainFrom && i <= domainTo) {
					    var c = icn3dui.giSeq.charAt(i);
					    var pos = (i+1).toString();

					  	html += '<span id="' + pre + '_' + gi + '_' + pos + '" title="' + c + pos + '" class="icn3d-residue">' + c + '</span>';
					  }
					  else {
					  	html += '<span></span>'; //'<span>-</span>';
					  }
					}
					html += '<span class="icn3d-residueNum" title="ending protein sequence number">' + (domainTo+1).toString() + '</span>';
					html += '</span>';
					html += '<br>';
				}

			    var siteArray = data.data[0].sites;

			    for(var index = 0, indexl = siteArray.length; index < indexl; ++index) {
					var domain = siteArray[index].srcdom;
					var type = siteArray[index].type;
					var resCnt = siteArray[index].sz;

					var title = 'site: ' + siteArray[index].title;
					if(title.length > 20) title = title.substr(0, 20) + '...';

					var fulltitle = 'site: ' + siteArray[index].title + ' (domain: ' + domain + ')';

					var resPosArray = siteArray[index].locs[0].coords;

					html += '<div class="icn3d-seqTitle link" site="site" posarray="' + resPosArray.toString() + '" shorttitle="' + title + '" anno="sequence" title="' + fulltitle + '">' + title + ' </div>';
					html += '<span class="icn3d-seqLine">';
					html += '<span class="icn3d-residueNum" title="residue count in the site">' + resCnt.toString() + ' Residues</span>';

					var pre = 'site' + index.toString();
					for(var i = 0, il = icn3dui.giSeq.length; i < il; ++i) {
					  if(resPosArray.indexOf(i) != -1) {
					    var c = icn3dui.giSeq.charAt(i);
					    var pos = (i+1).toString();

					  	html += '<span id="' + pre + '_' + gi + '_' + pos + '" title="' + c + pos + '" class="icn3d-residue">' + c + '</span>';
					  }
					  else {
					  	html += '<span></span>'; //'<span>-</span>';
					  }
					}
					html += '<span class="icn3d-residueNum" title="residue count in the site">' + resCnt.toString() + ' Residues</span>';
					html += '</span>';
					html += '<br>';
				}

				html += '</div>';

				$("#" + cdddivid).html(html);

				// add here after the ajax call
				selectSequenceNonMobile();
			  }
			})
			.fail(function() {
				alert( "No CDD data were found for the gi " + gi + "..." );
			});
		}

		function showDomain() {
			// show 3D domains
			var url;
			if(pdbid === undefined) {
			  url = "https://www.ncbi.nlm.nih.gov/Structure/mmdb/mmdb_strview.cgi?program=w3d&gi=" + gi;
			}
			else {
			  url = "https://www.ncbi.nlm.nih.gov/Structure/mmdb/mmdb_strview.cgi?program=w3d&uid=" + pdbid;
			}

			$.ajax({
			  url: url,
			  dataType: 'json',
			  cache: true,
			  success: function(data) {
			    var html = '<div id="domainseq_sequence" class="icn3d-dl_sequence">';

			    var domainArray, proteinname;

			    if(pdbid === undefined) {
			      domainArray = data.domains['1']; // just check the first molecule
			      proteinname = data.molid2molinfor['1'].name;
			    }
			    else {
			      var chain = gi.substr(5);

			      var molinfo = data.molid2molinfor;
			      var currMolid;
			      for(var molid in molinfo) {
			        if(molinfo[molid].chain === chain) {
			          currMolid = molid;
			          proteinname = molinfo[molid].name;
			          break;
			        }
			      }

			      if(currMolid !== undefined) {
					  domainArray = data.domains[currMolid];
//console.log("currMolid: " + currMolid);
			      }
			      else {
					  domainArray = data.domains['1']; // just check the first molecule
					  proteinname = data.molid2molinfor['1'].name;
			      }
			    }

			    for(var index = 0, indexl = domainArray.length; index < indexl; ++index) {
					var fulltitle = '3D domain ' + (index+1).toString() + ' of ' + proteinname + ' (PDB ID: ' + data.pdbId + ')';
					var title = (fulltitle.length > 20) ? fulltitle.substr(0,20) + '...' : fulltitle;

					var domainFrom = parseInt(domainArray[index][0][0]) - 1; // 1-based
					var domainTo = parseInt(domainArray[index][0][1]) - 1;
					var range = domainTo - domainFrom + 1;

					html += '<div class="icn3d-seqTitle link" domain="' + (index+1).toString() + '" from="' + domainFrom.toString() + '" to="' + domainTo.toString() + '" shorttitle="' + title + '" anno="sequence" title="' + fulltitle + '">' + title + ' </div>';
					html += '<span class="icn3d-seqLine">';
					html += '<span class="icn3d-residueNum" title="starting protein sequence number">' + (domainFrom+1).toString() + '</span>';

					var pre = 'domain3d' + index.toString();
					for(var i = 0, il = icn3dui.giSeq.length; i < il; ++i) {
					  if(i >= domainFrom && i <= domainTo) {
					    var c = icn3dui.giSeq.charAt(i);
					    var pos = (i+1).toString();

					  	html += '<span id="' + pre + '_' + gi + '_' + pos + '" title="' + c + pos + '" class="icn3d-residue">' + c + '</span>';
					  }
					  else {
					  	html += '<span></span>'; //'<span>-</span>';
					  }
					}
					html += '<span class="icn3d-residueNum" title="ending protein sequence number">' + (domainTo+1).toString() + '</span>';
					html += '</span>';
					html += '<br>';
				}

				html += '</div>';

				$("#" + domaindivid).html(html);

				// add here after the ajax call
				selectSequenceNonMobile();
			  }
			})
			.fail(function() {
				alert( "No 3D domain data were found for the gi " + gi + "..." );
			});
		}

        // show the sequence and 3D structure
        var url = "https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=protein&retmode=json&rettype=fasta&id=" + gi;
        $.ajax({
          url: url,
          dataType: 'text',
          cache: true,
          success: function(data) {
          	showSeq(data);

          	icn3dui.show3DStructure();

          	showCddSite();

          	showDomain();

          	showSnp();

          	navClinVar();

          	//selectSequenceNonMobile();

          }
        })
        .fail(function() {
            alert( "No data were found for the nucleotide " + nid + " and the gi " + gi + "..." );
        });

//		  $("#" + dnadivid).on("from_icn3d", function(event, data) {
//		  });

    }); // document ready

  </script>





</body></html>
